<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>統合電気シミュレーター</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #005BAB;
            --primary-dark: #004590;
            --primary-light: #E0EEF9;
            --accent-color: #FF961C;
            --secondary-color: #4D8BC9;
            --bg-color: #f5f5f5;
            --text-color: #333;
            --gray-light: #e0e0e0;
            --gray-medium: #9e9e9e;
            --gray-dark: #616161;
            --red-color: #d32f2f;
            --green-color: #388e3c;
            --yellow-color: #ffc107;
            --blue-light: #e3f2fd;
            --blue-dark: #1e3a8a;
            --wire-red: #ff0000;
            --wire-white: #ffffff;
            --wire-black: #000000;
            --breaker-green: #5cb85c;
            --mlb-color: #ffa366;
            --seismic-color: #e91e63;
            --elcb-color: #9c27b0;
            --grid-tie-color: #2196f3;
            --solar-color: #4caf50;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            
            --border-radius: 8px;
            --padding-standard: 16px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;

            --transition-standard: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', 'Meiryo', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* ヘッダー */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 20px 0;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        /* タブナビゲーション */
        .tab-nav {
            background-color: white;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 60px;
            z-index: 99;
        }

        .tab-nav-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 5px;
            overflow-x: auto;
        }

        .tab-nav button {
            background: none;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 15px;
            color: var(--gray-medium);
            transition: var(--transition-standard);
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            font-weight: 500;
        }

        .tab-nav button:hover {
            background-color: rgba(0, 91, 171, 0.05);
        }

        .tab-nav button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background-color: rgba(0, 91, 171, 0.05);
        }

        /* メインコンテナ */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            min-height: calc(100vh - 120px);
        }

        /* タブコンテンツ */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 共通パネルスタイル */
        .panel {
            background: white;
            padding: var(--padding-standard);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin-bottom: 20px;
            transition: var(--transition-standard);
        }

        .panel:hover {
            box-shadow: var(--shadow-lg);
        }

        .panel h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 10px;
        }

        /* ボタンスタイル */
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition-standard);
            font-weight: 500;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: var(--primary-color);
        }

        /* レスポンシブグリッド */
        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        @media (max-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }

        /* アニメーション効果 */
        .current-path {
            stroke-dasharray: 5;
            animation: flow 0.5s linear infinite;
        }

        @keyframes flow {
            to {
                stroke-dashoffset: -10;
            }
        }

        /* SVGコンテナ */
        .svg-container {
            width: 100%;
            overflow: auto;
            position: relative;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            background-color: #f8f8f8;
            min-height: 400px;
        }

        /* ローディング表示 */
        .loading {
            text-align: center;
            padding: 50px;
            color: var(--gray-medium);
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(3, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* プレースホルダーメッセージ */
        .placeholder-message {
            text-align: center;
            padding: 100px 20px;
            color: var(--gray-medium);
            font-size: 18px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>統合電気シミュレーター</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="resetAll()">全てリセット</button>
            </div>
        </div>
    </header>

    <nav class="tab-nav">
        <div class="tab-nav-content">
            <button class="tab-btn active" onclick="showTab('circuit-rich')" data-tab="circuit-rich">
                回路シミュレーター
            </button>
            <button class="tab-btn" onclick="showTab('circuit-config')" data-tab="circuit-config">
                分電盤回路構成シミュレーター
            </button>
            <button class="tab-btn" onclick="showTab('breaker')" data-tab="breaker">
                分電盤ブレーカー遮断シミュレーター
            </button>
            <button class="tab-btn" onclick="showTab('solar')" data-tab="solar">
                太陽光発電システム
            </button>
        </div>
    </nav>

    <div class="container">
        <!-- 回路シミュレーター（リッチ版） -->
        <div id="circuit-rich" class="tab-content active">
            <div class="panel">
                <h2>回路シミュレーター</h2>
                <p>電気回路の基礎を学習し、実際の配線をシミュレートできます。</p>
                <iframe src="circuit-simulator-rich.html" 
                        style="width: 100%; height: 800px; border: 1px solid var(--gray-light); border-radius: var(--border-radius);"
                        title="回路シミュレーター"
                        sandbox="allow-scripts allow-same-origin allow-forms">
                    <p>このブラウザではiframeがサポートされていません。<a href="circuit-simulator-rich.html" target="_blank">こちらから直接アクセス</a>してください。</p>
                </iframe>
            </div>
        </div>

        <!-- 分電盤回路構成シミュレーター -->
        <div id="circuit-config" class="tab-content">
            <div class="panel">
                <h2>分電盤回路構成シミュレーター</h2>
                <p>住宅分電盤の回路構成を学習し、設計をシミュレートできます。</p>
                <iframe src="distribution-board-simulator.html" 
                        style="width: 100%; height: 800px; border: 1px solid var(--gray-light); border-radius: var(--border-radius);"
                        title="分電盤回路構成シミュレーター"
                        sandbox="allow-scripts allow-same-origin allow-forms">
                    <p>このブラウザではiframeがサポートされていません。<a href="distribution-board-simulator.html" target="_blank">こちらから直接アクセス</a>してください。</p>
                </iframe>
            </div>
        </div>

        <!-- 住宅分電盤ブレーカー遮断シミュレーター -->
        <div id="breaker" class="tab-content">
            <div class="panel">
                <h2>分電盤ブレーカー遮断シミュレーター</h2>
                <p>住宅分電盤のブレーカー動作を学習し、遮断シミュレートできます。</p>
                <iframe src="residential-breaker-simulator.html" 
                        style="width: 100%; height: 800px; border: 1px solid var(--gray-light); border-radius: var(--border-radius);"
                        title="住宅分電盤ブレーカー遮断シミュレーター"
                        sandbox="allow-scripts allow-same-origin allow-forms">
                    <p>このブラウザではiframeがサポートされていません。<a href="residential-breaker-simulator.html" target="_blank">こちらから直接アクセス</a>してください。</p>
                </iframe>
            </div>
        </div>

        <!-- 太陽光発電システムシミュレーター -->
        <div id="solar" class="tab-content">
            <div class="panel">
                <h2>太陽光発電システムシミュレーター</h2>
                <p>太陽光発電システムの設計と動作をシミュレートできます。地域の日照条件から最適なシステム構成を計算します。</p>
            </div>
            
            <!-- 太陽光シミュレーターの内容 -->
            <div class="grid">
                <div>
                    <!-- 左側のパネル：設定 -->
                    <div class="panel">
                        <h2>設置地域情報</h2>
                        <div class="form-group">
                            <label for="prefecture-solar">都道府県:</label>
                            <select id="prefecture-solar">
                                <option value="">都道府県を選択してください</option>
                                <option value="北海道">北海道</option>
                                <option value="青森県">青森県</option>
                                <option value="岩手県">岩手県</option>
                                <option value="宮城県">宮城県</option>
                                <option value="秋田県">秋田県</option>
                                <option value="山形県">山形県</option>
                                <option value="福島県">福島県</option>
                                <option value="茨城県">茨城県</option>
                                <option value="栃木県">栃木県</option>
                                <option value="群馬県">群馬県</option>
                                <option value="埼玉県">埼玉県</option>
                                <option value="千葉県">千葉県</option>
                                <option value="東京都">東京都</option>
                                <option value="神奈川県">神奈川県</option>
                                <option value="新潟県">新潟県</option>
                                <option value="富山県">富山県</option>
                                <option value="石川県">石川県</option>
                                <option value="福井県">福井県</option>
                                <option value="山梨県">山梨県</option>
                                <option value="長野県">長野県</option>
                                <option value="岐阜県">岐阜県</option>
                                <option value="静岡県">静岡県</option>
                                <option value="愛知県">愛知県</option>
                                <option value="三重県">三重県</option>
                                <option value="滋賀県">滋賀県</option>
                                <option value="京都府">京都府</option>
                                <option value="大阪府">大阪府</option>
                                <option value="兵庫県">兵庫県</option>
                                <option value="奈良県">奈良県</option>
                                <option value="和歌山県">和歌山県</option>
                                <option value="鳥取県">鳥取県</option>
                                <option value="島根県">島根県</option>
                                <option value="岡山県">岡山県</option>
                                <option value="広島県">広島県</option>
                                <option value="山口県">山口県</option>
                                <option value="徳島県">徳島県</option>
                                <option value="香川県">香川県</option>
                                <option value="愛媛県">愛媛県</option>
                                <option value="高知県">高知県</option>
                                <option value="福岡県">福岡県</option>
                                <option value="佐賀県">佐賀県</option>
                                <option value="長崎県">長崎県</option>
                                <option value="熊本県">熊本県</option>
                                <option value="大分県">大分県</option>
                                <option value="宮崎県">宮崎県</option>
                                <option value="鹿児島県">鹿児島県</option>
                                <option value="沖縄県">沖縄県</option>
                            </select>
                        </div>
                        
                        <div id="locationInfoPanel-solar" style="display:none; background-color: #fff3e0; border: 1px solid #ffcc80; border-radius: 5px; padding: 10px; margin-top: 10px; font-size: 0.9rem;">
                            <strong>地域情報:</strong><br>
                            年間日照時間: <span id="annualSunshineHours-solar">-</span> 時間<br>
                            全国平均との比: <span id="sunshineRatio-solar">-</span>%<br>
                            <small>※この地域の日照特性が発電量計算に反映されます</small>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <h2>モジュール・ストリング設定</h2>
                        <div class="form-group">
                            <label for="panelPower-solar">パネル定格出力 (W):</label>
                            <input type="number" id="panelPower-solar" min="100" max="1000" value="330">
                        </div>
                        
                        <div class="form-group">
                            <label for="panelEfficiency-solar">パネル変換効率 (%):</label>
                            <input type="number" id="panelEfficiency-solar" min="15" max="25" step="0.1" value="19.5">
                        </div>
                        
                        <div class="form-group">
                            <label for="panelCount-solar">パネル枚数:</label>
                            <input type="number" id="panelCount-solar" min="1" max="100" value="12">
                        </div>
                        
                        <div class="form-group">
                            <label for="stringCount-solar">ストリング数:</label>
                            <input type="number" id="stringCount-solar" min="1" max="10" value="3">
                        </div>
                    </div>
                    
                    <div class="panel">
                        <h2>環境条件</h2>
                        <div class="form-group">
                            <label for="weatherCondition-solar">天候条件:</label>
                            <select id="weatherCondition-solar">
                                <option value="晴れ">晴れ</option>
                                <option value="薄曇り">薄曇り</option>
                                <option value="曇り">曇り</option>
                                <option value="雨">雨</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="temperature-solar">周囲温度 (℃):</label>
                            <input type="range" id="temperature-solar" min="-10" max="50" value="25" step="1">
                            <span id="temperatureValue-solar" style="display: inline-block; width: 50px; text-align: right; margin-left: 10px;">25℃</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="tiltAngle-solar">パネル傾斜角 (°):</label>
                            <input type="range" id="tiltAngle-solar" min="0" max="90" value="30" step="1">
                            <span id="tiltAngleValue-solar" style="display: inline-block; width: 50px; text-align: right; margin-left: 10px;">30°</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="orientationAngle-solar">方位角 (°):</label>
                            <input type="range" id="orientationAngle-solar" min="-90" max="90" value="0" step="1">
                            <span id="orientationAngleValue-solar" style="display: inline-block; width: 50px; text-align: right; margin-left: 10px;">0° (真南)</span>
                        </div>
                    </div>
                    
                    <button id="calculateBtn-solar" class="btn">シミュレーション実行</button>
                </div>
            
                <div>
                    <!-- 右側のパネル：結果 -->
                    <div class="panel">
                        <h2>シミュレーション結果</h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <h3 style="color: #005BAB; font-size: 1.1rem; margin-bottom: 0.5rem;">システム情報</h3>
                                <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                                    <strong>システム容量:</strong>
                                    <span id="systemCapacity-solar" style="font-weight: bold; color: var(--primary-color);">-</span>
                                </div>
                                <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                                    <strong>モジュール枚数:</strong>
                                    <span id="modulesCount-solar" style="font-weight: bold; color: var(--primary-color);">-</span>
                                </div>
                                <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                                    <strong>ストリング数:</strong>
                                    <span id="stringsCount-solar" style="font-weight: bold; color: var(--primary-color);">-</span>
                                </div>
                            </div>
                            
                            <div>
                                <h3 style="color: #005BAB; font-size: 1.1rem; margin-bottom: 0.5rem;">発電量予測</h3>
                                <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                                    <strong>発電電力（瞬時）:</strong>
                                    <span id="instantPower-solar" style="font-weight: bold; color: var(--primary-color);">-</span>
                                </div>
                                <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                                    <strong>日間発電量（推定）:</strong>
                                    <span id="dailyGeneration-solar" style="font-weight: bold; color: var(--primary-color);">-</span>
                                </div>
                                <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                                    <strong>月間発電量（推定）:</strong>
                                    <span id="monthlyGeneration-solar" style="font-weight: bold; color: var(--primary-color);">-</span>
                                </div>
                                <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                                    <strong>年間発電量（推定）:</strong>
                                    <span id="yearlyGeneration-solar" style="font-weight: bold; color: var(--primary-color);">-</span>
                                </div>
                            </div>
                            
                            <div>
                                <h3 style="color: #005BAB; font-size: 1.1rem; margin-bottom: 0.5rem;">各種効率係数</h3>
                                <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                                    <strong>地域日照係数:</strong>
                                    <span id="regionalSunshineFactor-solar" style="font-weight: bold; color: var(--primary-color);">-</span>
                                </div>
                                <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                                    <strong>天候の影響:</strong>
                                    <span id="weatherFactor-solar" style="font-weight: bold; color: var(--primary-color);">-</span>
                                </div>
                                <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                                    <strong>傾斜・方位角の影響:</strong>
                                    <span id="orientationFactor-solar" style="font-weight: bold; color: var(--primary-color);">-</span>
                                </div>
                                <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                                    <strong>温度の影響:</strong>
                                    <span id="temperatureFactor-solar" style="font-weight: bold; color: var(--primary-color);">-</span>
                                </div>
                                <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                                    <strong>システム効率:</strong>
                                    <span id="totalEfficiency-solar" style="font-weight: bold; color: var(--primary-color);">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- グラフ表示部分 -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                            <div style="background-color: white; border-radius: 8px; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1); padding: 20px;">
                                <h3 style="color: var(--primary-color); margin-top: 0; margin-bottom: 15px; text-align: center;">月別発電量予測</h3>
                                <canvas id="monthlyChart-solar"></canvas>
                            </div>
                            <div style="background-color: white; border-radius: 8px; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1); padding: 20px;">
                                <h3 style="color: var(--primary-color); margin-top: 0; margin-bottom: 15px; text-align: center;">効率ロス分析</h3>
                                <canvas id="lossChart-solar"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- システム構成図 -->
                    <div class="panel">
                        <h2>システム構成図</h2>
                        <div id="solarPanelVisualization-solar" style="text-align: center; margin-top: 20px;">
                            <h3 style="color: #005BAB; font-size: 1.1rem; margin-bottom: 1rem;">ソーラーパネル配置</h3>
                            <div id="panelGridContainer-solar" style="min-height: 200px; background-color: #f8f8f8; border: 2px solid var(--gray-light); border-radius: var(--border-radius); padding: 20px;">
                                <!-- パネル配置はJSで動的に生成 -->
                                <p>シミュレーション実行後にパネル配置図が表示されます</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // タブ切り替え機能
        function showTab(tabId) {
            console.log(`Switching to tab: ${tabId}`);
            
            // すべてのタブコンテンツを非表示
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // すべてのタブボタンの非アクティブ化
            const allButtons = document.querySelectorAll('.tab-btn');
            allButtons.forEach(btn => {
                btn.classList.remove('active');
            });

            // 選択されたタブを表示
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
                console.log(`Activated tab: ${tabId}`);
            } else {
                console.error(`Tab not found: ${tabId}`);
            }

            // クリックされたボタンをアクティブ化
            event.target.classList.add('active');
        }

        // タブ名を取得
        function getTabName(tabId) {
            const tabNames = {
                'breaker': '住宅分電盤ブレーカー',
                'circuit-config': '分電盤回路構成',
                'circuit-rich': '回路シミュレーター',
                'solar': '太陽光発電システム'
            };
            return tabNames[tabId] || '';
        }

        // タブコンテンツを動的に読み込む（プレースホルダー）
        function loadTabContent(tabId) {
            console.log(`Loading content for: ${tabId}`);
            // 実際の実装では、ここで各シミュレーターのコンテンツを
            // 動的に読み込んで表示します
        }

        // 全リセット機能
        function resetAll() {
            if (confirm('すべてのシミュレーターをリセットしますか？')) {
                // 各シミュレーターのリセット処理
                console.log('Resetting all simulators...');
                location.reload();
            }
        }

        // 太陽光シミュレーター機能
        const SolarSimulator = {
            // 都道府県別日照時間データ（1991-2020年平年値）
            prefectureSunshineData: {
                '北海道': { hours: 1740.4, ratio: 0.908 },
                '青森県': { hours: 1589.2, ratio: 0.829 },
                '岩手県': { hours: 1667.5, ratio: 0.870 },
                '宮城県': { hours: 1796.1, ratio: 0.937 },
                '秋田県': { hours: 1527.4, ratio: 0.797 },
                '山形県': { hours: 1617.9, ratio: 0.844 },
                '福島県': { hours: 1766.4, ratio: 0.922 },
                '茨城県': { hours: 1897.2, ratio: 0.990 },
                '栃木県': { hours: 1938.4, ratio: 1.011 },
                '群馬県': { hours: 2153.7, ratio: 1.124 },
                '埼玉県': { hours: 2056.6, ratio: 1.073 },
                '千葉県': { hours: 1851.5, ratio: 0.966 },
                '東京都': { hours: 1881.3, ratio: 0.982 },
                '神奈川県': { hours: 2020.5, ratio: 1.054 },
                '新潟県': { hours: 1639.6, ratio: 0.856 },
                '富山県': { hours: 1647.2, ratio: 0.860 },
                '石川県': { hours: 1680.9, ratio: 0.877 },
                '福井県': { hours: 1689.4, ratio: 0.882 },
                '山梨県': { hours: 2225.8, ratio: 1.162 },
                '長野県': { hours: 2061.0, ratio: 1.076 },
                '岐阜県': { hours: 2108.6, ratio: 1.101 },
                '静岡県': { hours: 2151.5, ratio: 1.123 },
                '愛知県': { hours: 2141.0, ratio: 1.118 },
                '三重県': { hours: 2030.5, ratio: 1.060 },
                '滋賀県': { hours: 1832.4, ratio: 0.956 },
                '京都府': { hours: 1851.4, ratio: 0.966 },
                '大阪府': { hours: 1996.3, ratio: 1.042 },
                '兵庫県': { hours: 2044.1, ratio: 1.067 },
                '奈良県': { hours: 1990.7, ratio: 1.039 },
                '和歌山県': { hours: 2116.9, ratio: 1.105 },
                '鳥取県': { hours: 1707.0, ratio: 0.891 },
                '島根県': { hours: 1720.5, ratio: 0.898 },
                '岡山県': { hours: 2089.5, ratio: 1.091 },
                '広島県': { hours: 2033.2, ratio: 1.061 },
                '山口県': { hours: 1956.6, ratio: 1.021 },
                '徳島県': { hours: 2092.6, ratio: 1.092 },
                '香川県': { hours: 2085.2, ratio: 1.089 },
                '愛媛県': { hours: 2017.4, ratio: 1.053 },
                '高知県': { hours: 2159.7, ratio: 1.127 },
                '福岡県': { hours: 1869.0, ratio: 0.975 },
                '佐賀県': { hours: 1852.4, ratio: 0.967 },
                '長崎県': { hours: 1861.4, ratio: 0.971 },
                '熊本県': { hours: 1925.3, ratio: 1.005 },
                '大分県': { hours: 1928.0, ratio: 1.006 },
                '宮崎県': { hours: 2121.7, ratio: 1.107 },
                '鹿児島県': { hours: 1935.6, ratio: 1.010 },
                '沖縄県': { hours: 1812.9, ratio: 0.946 }
            },

            config: {
                prefecture: '',
                regionalSunshineFactor: 1.0,
                panelCount: 12,
                panelPower: 330,
                panelEfficiency: 19.5,
                stringCount: 3,
                weatherCondition: '晴れ',
                temperature: 25,
                tiltAngle: 30,
                orientationAngle: 0
            },

            results: {
                totalCapacity: 0,
                instantPower: 0,
                dailyGeneration: 0,
                monthlyGeneration: 0,
                yearlyGeneration: 0,
                totalEfficiency: 0,
                regionalSunshineFactor: 100,
                weatherFactor: 100,
                orientationFactor: 100,
                temperatureFactor: 100,
                monthlyGenerations: []
            },

            charts: {
                monthly: null,
                loss: null
            },

            // 初期化
            init: function() {
                this.setupEventListeners();
                this.calculate();
            },

            // イベントリスナーの設定
            setupEventListeners: function() {
                const self = this;

                // 都道府県選択
                document.getElementById('prefecture-solar').addEventListener('change', function() {
                    self.config.prefecture = this.value;
                    self.updateLocationInfo();
                });

                // パネル設定
                document.getElementById('panelPower-solar').addEventListener('change', function() {
                    self.config.panelPower = parseInt(this.value) || 330;
                });

                document.getElementById('panelEfficiency-solar').addEventListener('change', function() {
                    self.config.panelEfficiency = parseFloat(this.value) || 19.5;
                });

                document.getElementById('panelCount-solar').addEventListener('change', function() {
                    self.config.panelCount = parseInt(this.value) || 12;
                });

                document.getElementById('stringCount-solar').addEventListener('change', function() {
                    self.config.stringCount = parseInt(this.value) || 3;
                });

                // 環境条件
                document.getElementById('weatherCondition-solar').addEventListener('change', function() {
                    self.config.weatherCondition = this.value;
                });

                document.getElementById('temperature-solar').addEventListener('input', function() {
                    self.config.temperature = parseInt(this.value) || 25;
                    document.getElementById('temperatureValue-solar').textContent = self.config.temperature + '℃';
                });

                document.getElementById('tiltAngle-solar').addEventListener('input', function() {
                    self.config.tiltAngle = parseInt(this.value) || 30;
                    document.getElementById('tiltAngleValue-solar').textContent = self.config.tiltAngle + '°';
                });

                document.getElementById('orientationAngle-solar').addEventListener('input', function() {
                    self.config.orientationAngle = parseInt(this.value) || 0;
                    let text = self.config.orientationAngle + '°';
                    if (self.config.orientationAngle === 0) {
                        text += ' (真南)';
                    } else if (self.config.orientationAngle < 0) {
                        text += ` (東${Math.abs(self.config.orientationAngle)}°)`;
                    } else {
                        text += ` (西${self.config.orientationAngle}°)`;
                    }
                    document.getElementById('orientationAngleValue-solar').textContent = text;
                });

                // 計算ボタン
                document.getElementById('calculateBtn-solar').addEventListener('click', function() {
                    self.calculate();
                    self.updateCharts();
                    self.renderPanelGrid();
                });
            },

            // 地域情報の更新
            updateLocationInfo: function() {
                const panel = document.getElementById('locationInfoPanel-solar');
                const hoursEl = document.getElementById('annualSunshineHours-solar');
                const ratioEl = document.getElementById('sunshineRatio-solar');

                if (this.config.prefecture && this.prefectureSunshineData[this.config.prefecture]) {
                    const data = this.prefectureSunshineData[this.config.prefecture];
                    this.config.regionalSunshineFactor = data.ratio;
                    
                    panel.style.display = 'block';
                    hoursEl.textContent = data.hours.toFixed(1);
                    ratioEl.textContent = (data.ratio * 100).toFixed(1);
                } else {
                    panel.style.display = 'none';
                    this.config.regionalSunshineFactor = 1.0;
                }
            },

            // 計算実行
            calculate: function() {
                // システム容量計算
                const totalCapacity = (this.config.panelCount * this.config.panelPower) / 1000;

                // 天候係数
                const weatherFactors = {
                    '晴れ': 1.0,
                    '薄曇り': 0.7,
                    '曇り': 0.4,
                    '雨': 0.2
                };
                const weatherFactor = weatherFactors[this.config.weatherCondition] || 0.7;

                // 方位・傾斜角の影響
                const orientationFactor = this.calculateOrientationFactor();

                // 温度の影響
                const temperatureFactor = this.calculateTemperatureFactor();

                // システム効率（配線損失、ミスマッチなど）
                const systemEfficiency = 0.95;

                // 瞬時発電電力
                const instantPower = totalCapacity * weatherFactor * orientationFactor * temperatureFactor * systemEfficiency;

                // 日照時間
                const baseDailySunHours = {
                    "晴れ": 5.0,
                    "薄曇り": 4.0,
                    "曇り": 3.0,
                    "雨": 1.5
                };
                const dailySunHours = baseDailySunHours[this.config.weatherCondition] * this.config.regionalSunshineFactor;

                // 発電量計算
                const dailyGeneration = instantPower * dailySunHours;
                const monthlyGeneration = dailyGeneration * 30;

                // 月別発電量の計算
                const monthlyMultipliers = [0.7, 0.8, 0.9, 1.0, 1.05, 0.9, 1.0, 1.0, 0.85, 0.8, 0.7, 0.65];
                const monthlyGenerations = monthlyMultipliers.map(mult => monthlyGeneration * mult);
                const yearlyGeneration = monthlyGenerations.reduce((sum, val) => sum + val, 0);

                // 総合効率
                const totalEfficiency = weatherFactor * orientationFactor * temperatureFactor * systemEfficiency;

                // 結果を保存
                this.results = {
                    totalCapacity,
                    instantPower,
                    dailyGeneration,
                    monthlyGeneration,
                    yearlyGeneration,
                    totalEfficiency: totalEfficiency * 100,
                    regionalSunshineFactor: this.config.regionalSunshineFactor * 100,
                    weatherFactor: weatherFactor * 100,
                    orientationFactor: orientationFactor * 100,
                    temperatureFactor: temperatureFactor * 100,
                    monthlyGenerations
                };

                this.displayResults();
            },

            // 方位・傾斜角の影響計算
            calculateOrientationFactor: function() {
                const optimalTiltAngle = 30;
                let tiltEfficiency = 1.0 - Math.abs(this.config.tiltAngle - optimalTiltAngle) * 0.005;
                if (tiltEfficiency < 0.7) tiltEfficiency = 0.7;

                let orientationEfficiency = 1.0 - Math.abs(this.config.orientationAngle) * 0.002;
                if (orientationEfficiency < 0.8) orientationEfficiency = 0.8;

                return tiltEfficiency * orientationEfficiency;
            },

            // 温度の影響計算
            calculateTemperatureFactor: function() {
                const temperatureCoefficient = -0.004;
                return 1 + temperatureCoefficient * (this.config.temperature - 25);
            },

            // 結果表示
            displayResults: function() {
                document.getElementById('systemCapacity-solar').textContent = this.results.totalCapacity.toFixed(2) + ' kW';
                document.getElementById('modulesCount-solar').textContent = this.config.panelCount + ' 枚';
                document.getElementById('stringsCount-solar').textContent = this.config.stringCount + ' 系統';
                document.getElementById('instantPower-solar').textContent = this.results.instantPower.toFixed(2) + ' kW';
                document.getElementById('dailyGeneration-solar').textContent = this.results.dailyGeneration.toFixed(2) + ' kWh';
                document.getElementById('monthlyGeneration-solar').textContent = this.results.monthlyGeneration.toFixed(2) + ' kWh';
                document.getElementById('yearlyGeneration-solar').textContent = this.results.yearlyGeneration.toFixed(2) + ' kWh';
                document.getElementById('regionalSunshineFactor-solar').textContent = this.results.regionalSunshineFactor.toFixed(1) + '%';
                document.getElementById('weatherFactor-solar').textContent = this.results.weatherFactor.toFixed(1) + '%';
                document.getElementById('orientationFactor-solar').textContent = this.results.orientationFactor.toFixed(1) + '%';
                document.getElementById('temperatureFactor-solar').textContent = this.results.temperatureFactor.toFixed(1) + '%';
                document.getElementById('totalEfficiency-solar').textContent = this.results.totalEfficiency.toFixed(1) + '%';
            },

            // チャート更新
            updateCharts: function() {
                this.updateMonthlyChart();
                this.updateLossChart();
            },

            // 月別発電量チャート
            updateMonthlyChart: function() {
                const ctx = document.getElementById('monthlyChart-solar');
                if (!ctx) return;

                if (this.charts.monthly) {
                    this.charts.monthly.destroy();
                }

                const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];

                this.charts.monthly = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: monthNames,
                        datasets: [{
                            label: '月間発電量 (kWh)',
                            data: this.results.monthlyGenerations,
                            backgroundColor: 'rgba(0, 91, 171, 0.7)',
                            borderColor: 'rgba(0, 91, 171, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '発電量 (kWh)'
                                }
                            }
                        }
                    }
                });
            },

            // 効率ロスチャート
            updateLossChart: function() {
                const ctx = document.getElementById('lossChart-solar');
                if (!ctx) return;

                if (this.charts.loss) {
                    this.charts.loss.destroy();
                }

                const labels = ['実発電量', '天候による損失', '方位・傾斜角による損失', '温度による損失', 'その他損失'];
                const actualOutput = this.results.totalEfficiency / 100;
                const weatherLoss = (100 - this.results.weatherFactor) / 100;
                const orientationLoss = (100 - this.results.orientationFactor) / 100 * 0.5;
                const temperatureLoss = (100 - this.results.temperatureFactor) / 100 * 0.3;
                const otherLoss = 1 - actualOutput - weatherLoss - orientationLoss - temperatureLoss;

                const data = [actualOutput, weatherLoss, orientationLoss, temperatureLoss, Math.max(0, otherLoss)];
                const backgroundColor = ['rgba(76, 175, 80, 0.7)', '#2196f3', '#ff9800', '#f44336', '#9c27b0'];

                this.charts.loss = new Chart(ctx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColor,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        return `${label}: ${(value * 100).toFixed(1)}%`;
                                    }
                                }
                            }
                        }
                    }
                });
            },

            // パネル配置図の描画
            renderPanelGrid: function() {
                const container = document.getElementById('panelGridContainer-solar');
                if (!container) return;

                const panelsPerString = Math.floor(this.config.panelCount / this.config.stringCount);
                const remainder = this.config.panelCount % this.config.stringCount;

                let html = '<div style="display: grid; gap: 10px;">';
                
                for (let i = 0; i < this.config.stringCount; i++) {
                    const panelCount = panelsPerString + (i < remainder ? 1 : 0);
                    html += `<div style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">`;
                    html += `<strong>ストリング ${i + 1}:</strong>`;
                    
                    for (let j = 0; j < panelCount; j++) {
                        html += `<div style="width: 30px; height: 20px; background-color: #4CAF50; border: 1px solid #333; border-radius: 2px; display: inline-block;"></div>`;
                    }
                    
                    html += ` (${panelCount}枚, ${(panelCount * this.config.panelPower).toFixed(0)}W)`;
                    html += `</div>`;
                }
                
                html += '</div>';
                container.innerHTML = html;
            }
        };

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 太陽光シミュレーターの初期化
            SolarSimulator.init();
            
            // 初期タブを表示（回路シミュレーターを最初に表示）
            showTab('circuit-rich');
        });
    </script>
</body>
</html>